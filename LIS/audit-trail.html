<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      #report-app .loader-section {
        padding: 5rem;
        text-align: center;
        background-color: #f2f2f2;
        margin-top: 10px;
        margin-bottom: 20px;
      }

      #report-app .spaced {
        margin-top: 5rem;
      }

      #report-app .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite;
      }
    </style>

    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="text/javascript">
      angular
        .module("reportModule", [])
        .factory("FactoryDefns", function ($window, $http) {
          var uri = "data:application/vnd.ms-excel;base64,",
            template =
              '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table border="1">{table}</table><br /><table border="1">{table}</table></body></html>',
            base64 = function (s) {
              return $window.btoa(unescape(encodeURIComponent(s)));
            },
            format = function (s, c) {
              return s.replace(/{(\w+)}/g, function (m, p) {
                return c[p];
              });
            };
          return {
            tableToExcel: function () {
              var tables = $(
                ".pop-table, .maternal-table, .cchp-table, .opd-table, .ipd-table, .death-table, .notifiable-table, .tracer-table"
              );
              var ctx = { worksheet: "Sheet 1" };
              var str =
                '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>';

              tables.each(function (index) {
                $(this)
                  .find("td.hidden")
                  .each(function (index2) {
                    this.remove();
                  });
                ctx["table" + index] = this.innerHTML;
                if (this.title == "no-border") {
                  str += "<table>{" + "table" + index + "}</table><br />";
                } else {
                  str +=
                    '<table border="1">{' + "table" + index + "}</table><br />";
                }
              });
              str += "</body></html>";
              var href = uri + base64(format(str, ctx));
              return href;
            },
            getSamplesList: async function (reportDimensions) {
              if (!reportDimensions) {
                return null;
              }
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/lab/samples?page=1&pageSize=10&startDate=${reportDimensions.startDate}&endDate=${reportDimensions.endDate}&hasStatus=YES&excludeAllocations=false`
                )
                .then((response) => {
                  return response.data;
                });
            },
            getDepartments: async function () {
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/concept?q=LAB_DEPARTMENT&limit=50&v=custom:(uuid,display)`
                )
                .then((response) => {
                  return response.data;
                });
            },
            getSpecimenSources: async function () {
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/concept?q=SPECIMEN_SOURCE&limit=50&v=custom:(uuid,display)`
                )
                .then((response) => {
                  return response.data;
                });
            },
          };
        })
        .controller("reportController", [
          "$scope",
          "$http",
          "$timeout",
          "$q",
          "FactoryDefns",
          function ($scope, $http, $timeout, $q, FactoryDefns) {
            $scope.currentUser = null;
            $scope.loading = false;
            $scope.departments = [];
            $scope.specimenSources = [];
            $scope.samplesData = {};
            $scope.today = new Date();
            $scope.startDate = null;
            $scope.endDate = null;
            $scope.reportDimensions = {
              startDate: null,
              endDate: null,
            };
            $scope.maximumParametersCount = 1;

            $scope.loadData = (reportDimensions) => {
              $scope.loading = true;
              FactoryDefns.getSamplesList(reportDimensions).then((response) => {
                $scope.samplesData = {
                  pager: response?.pager,
                  results: _.flatten(
                    response?.results?.map((result) => {
                      return result?.orders?.map((order) => {
                        const results = _.flatten(
                          (
                            order?.testAllocations?.filter(
                              (testAllocation) =>
                                testAllocation?.results?.length > 0
                            ) || []
                          )?.map(
                            (allocation) =>
                              allocation?.results.map((result) => {
                                return {
                                  ...result,
                                  concept: allocation?.concept,
                                  authorizationStatuses:
                                    allocation?.statuses?.filter(
                                      (status) =>
                                        status?.result?.uuid === result?.uuid
                                    ) || [],
                                };
                              }) || []
                          ) || []
                        );
                        if (
                          order?.testAllocations &&
                          $scope.maximumParametersCount <
                            order?.testAllocations.length
                        ) {
                          $scope.maximumParametersCount =
                            order?.testAllocations.length;
                        }
                        return {
                          ...result,
                          testOrder: order?.order,
                          testAllocations: order?.testAllocations,
                          results: results,
                          priority: (result?.statuses?.filter(
                            (status) => status?.category === "PRIORITY"
                          ) || [])[0],
                          authorizationStatuses: result?.authorizationStatuses,
                        };
                      });
                    })
                  ),
                };
                //   console.log($scope.samplesData);

                $scope.loading = false;
                $scope.$apply();
              });
            };

            FactoryDefns.getDepartments().then((response) => {
              if (response) {
                FactoryDefns.getSpecimenSources().then(
                  (departmentsResponse) => {
                    if (departmentsResponse) {
                      $scope.specimenSources = departmentsResponse?.results;
                      $scope.departments = response?.results;
                      //   $scope.loadData();
                    }
                  }
                );
              }
            });

            $scope.getDepertmentName = (uuid) => {
              let name = _.keyBy($scope.departments, "uuid")[uuid]?.display;
              return name ? name?.replace("LAB_DEPARTMENT:", "") : "-";
            };

            $scope.formatTestOrderName = (display) => {
              return display ? display.replace("TEST_ORDERS:", "") : "-";
            };

            $scope.getSpecimenSourceName = (specimenSource) => {
              return specimenSource?.display
                ? specimenSource?.display.replace("SPECIMEN_SOURCE:", "")
                : "-";
            };

            $scope.getAuthorizationStatus = (authorizationStatuses) => {
              return authorizationStatuses.length > 0
                ? authorizationStatuses[authorizationStatuses.length - 1]
                : null;
            };

            $scope.getResult = (results) => {
              if (results.length === 0) {
                return "-";
              }

              const result = results[results.length - 1];
              return result?.valueCoded
                ? result?.valueCoded?.display
                : result?.valueText
                ? result?.valueText
                : result?.valueNumeric
                ? result?.valueNumeric
                : "-";
            };

            $scope.getReport = (startDate, endDate) => {
              $scope.startDate = startDate;
              $scope.endDate = endDate;
              $scope.reportDimensions = {
                startDate: $scope.startDate.toISOString(),
                endDate: $scope.endDate.toISOString(),
              };
              if ($scope.startDate && $scope.endDate) {
                $scope.loadData($scope.reportDimensions);
              }
            };
          },
        ]);
    </script>
  </head>
  <body>
    <div id="report-app" ng-app="reportModule" ng-controller="reportController">
      <h3 class="text-center"><b> Audit Trail </b></h3>
      <div class="w-100">
        StartDate:
        <input
          ng-model="startDate"
          max="{{today}}"
          placeholder="Start date"
          type="date"
        />
        <span style="margin-left: 8px">
          End Date:
          <input ng-model="endDate" placeholder="End date" type="date" />
        </span>
        <button
          [disabled]="!startDate || !endDate"
          style="margin-left: 8px"
          ng-click="getReport(startDate,endDate)"
        >
          Get Report
        </button>
      </div>
      <div style="width: 100%; overflow: auto; margin-top: 8px">
        <table class="table table-bordered" ng-if="!loading">
          <thead>
            <tr>
              <th>SN</th>
              <th>Lab</th>
              <th>Department</th>
              <th>Specimen Source</th>
              <th>Lab No</th>
              <th>Registered On</th>
              <th>Priority</th>
              <th>File No.</th>
              <th>Test Order</th>
              <th>Has Results?</th>
              <th>Authorized?</th>
              <th>Authorized On</th>
              <th colspan="{{maximumParametersCount}}">Test Parameters</th>
            </tr>
          </thead>
          <tbody ng-repeat="sampleTestOrder in samplesData.results">
            <tr>
              <td style="width: 50px">{{$index + 1}}</td>
              <td style="width: 120px">
                {{sampleTestOrder.location.display ?
                sampleTestOrder.location.display: '-'}}
              </td>
              <td>{{getDepertmentName(sampleTestOrder.concept.uuid)}}</td>
              <td>{{getSpecimenSourceName(sampleTestOrder.specimenSource)}}</td>
              <td>{{sampleTestOrder.label}}</td>
              <td>{{sampleTestOrder.dateTimeCreated | date:"medium" }}</td>
              <td>{{sampleTestOrder.priority.remarks}}</td>
              <td>{{sampleTestOrder.patient.identifiers[0].id}}</td>
              <td>
                {{formatTestOrderName(sampleTestOrder.testOrder.concept.display)}}
              </td>
              <td>{{sampleTestOrder.results.length > 0 ? "Y": "N"}}</td>
              <td>
                {{sampleTestOrder.authorizationStatuses.length > 0 ? "Y": "N"}}
              </td>
              <td>
                {{ authorizationStatuses ?
                (getAuthorizationStatus(sampleTestOrder.authorizationStatuses) ?
                (getAuthorizationStatus(sampleTestOrder.authorizationStatuses).timestamp
                | date:"medium"):"-"): "-"}}
              </td>
              <td ng-repeat="testAllocation in sampleTestOrder.testAllocations">
                <p>{{testAllocation.concept.display}}</p>
                <p style="text-align: center">
                  <b> {{ getResult(testAllocation.results)}} </b>
                </p>
              </td>
            </tr>
          </tbody>
        </table>
        <div
          ng-if="loading"
          style="
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <div class="loader"></div>
        </div>
      </div>
    </div>
  </body>
</html>
