<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      #report-app .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite;
      }
      #report-app .control-btn {
        border-radius: 4px;
        padding: 6px;
      }
      #report-app .item-selection {
        padding: 8px;
      }

      #report-app .date-input {
        padding: 4px;
        border-radius: 3px;
      }
    </style>

    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="text/javascript">
      angular
        .module("reportModule", [])
        .factory("FactoryDefns", function ($window, $http) {
          var uri = "data:application/vnd.ms-excel;base64,",
            template =
              '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table border="1">{table}</table><br /><table border="1">{table}</table></body></html>',
            base64 = function (s) {
              return $window.btoa(unescape(encodeURIComponent(s)));
            },
            format = function (s, c) {
              return s.replace(/{(\w+)}/g, function (m, p) {
                return c[p];
              });
            };
          return {
            getSamplesList: async function (reportDimensions) {
              if (!reportDimensions) {
                return null;
              }
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/lab/samples?page=${
                    reportDimensions.page
                  }&pageSize=${reportDimensions.itemsPerPage}&startDate=${
                    reportDimensions.startDate
                  }&endDate=${
                    reportDimensions.endDate
                  }&hasStatus=YES&excludeAllocations=false${
                    reportDimensions?.department?.uuid
                      ? "&department=" + reportDimensions?.department?.uuid
                      : ""
                  }${
                    reportDimensions?.specimenSource?.uuid
                      ? "&specimen=" + reportDimensions?.specimenSource?.uuid
                      : ""
                  }${
                    reportDimensions?.testOrder?.uuid
                      ? "&test=" + reportDimensions?.testOrder?.uuid
                      : ""
                  }`
                )
                .then((response) => {
                  return response.data;
                });
            },
            getDepartments: async function () {
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/concept?q=LAB_DEPARTMENT&limit=50&v=custom:(uuid,display)`
                )
                .then((response) => {
                  return response.data;
                });
            },
            getSpecimenSources: async function () {
              return await $http
                .get(
                  `../../../../../openmrs/ws/rest/v1/concept?q=SPECIMEN_SOURCE&limit=50&v=custom:(uuid,display)`
                )
                .then((response) => {
                  return response.data;
                });
            },
          };
        })
        .controller("reportController", [
          "$scope",
          "$http",
          "$timeout",
          "$q",
          "FactoryDefns",
          function ($scope, $http, $timeout, $q, FactoryDefns) {
            $scope.loading = false;
            $scope.departments = null;
            $scope.specimenSources = null;
            $scope.testOrders = null;
            $scope.equipments = null;

            $scope.selectedDepartment = null;
            $scope.testOrder = null;
            $scope.specimenSource = null;
            $scope.equipment = null;

            $scope.samplesData = {};
            $scope.today = new Date();
            $scope.startDate = null;
            $scope.endDate = null;
            $scope.itemsPerPage = 10;
            $scope.currentPage = 1;
            $scope.reportDimensions = {
              startDate: null,
              endDate: null,
              page: 1,
              itemsPerPage: $scope.itemsPerPage,
            };
            $scope.maximumParametersCount = 1;

            $scope.loadData = (reportDimensions) => {
              $scope.loading = true;
              FactoryDefns.getSamplesList(reportDimensions).then((response) => {
                $scope.samplesData = {
                  pager: response?.pager,
                  results: _.flatten(
                    response?.results?.map((result) => {
                      return result?.orders?.map((order) => {
                        const results = _.flatten(
                          (
                            order?.testAllocations?.filter(
                              (testAllocation) =>
                                testAllocation?.results?.length > 0
                            ) || []
                          )?.map(
                            (allocation) =>
                              allocation?.results.map((result) => {
                                return {
                                  ...result,
                                  concept: allocation?.concept,
                                  authorizationStatuses:
                                    allocation?.statuses?.filter(
                                      (status) =>
                                        status?.result?.uuid === result?.uuid
                                    ) || [],
                                };
                              }) || []
                          ) || []
                        );
                        if (
                          order?.testAllocations &&
                          $scope.maximumParametersCount <
                            order?.testAllocations.length
                        ) {
                          $scope.maximumParametersCount =
                            order?.testAllocations.length;
                        }
                        return {
                          ...result,
                          testOrder: order?.order,
                          testAllocations: order?.testAllocations,
                          results: results,
                          priority: (result?.statuses?.filter(
                            (status) => status?.category === "PRIORITY"
                          ) || [])[0],
                          authorizationStatuses: result?.authorizationStatuses,
                        };
                      });
                    })
                  ),
                };
                //   console.log($scope.samplesData);

                $scope.loading = false;
                $scope.$apply();
              });
            };

            FactoryDefns.getDepartments().then((response) => {
              if (response) {
                console.log("response", response);
                $scope.departments = response?.results?.map((result) => {
                  return {
                    uuid: result?.uuid,
                    display: result?.display?.replace("LAB_DEPARTMENT:", ""),
                  };
                });
                FactoryDefns.getSpecimenSources().then(
                  (departmentsResponse) => {
                    if (departmentsResponse) {
                      $scope.specimenSources = departmentsResponse?.results;
                      //   $scope.loadData();
                    }
                  }
                );
                $scope.$apply();
              }
            });

            $scope.getDepertmentName = (uuid) => {
              let name = _.keyBy($scope.departments, "uuid")[uuid]?.display;
              return name ? name?.replace("LAB_DEPARTMENT:", "") : "-";
            };

            $scope.formatTestOrderName = (display) => {
              return display ? display.replace("TEST_ORDERS:", "") : "-";
            };

            $scope.getSpecimenSourceName = (specimenSource) => {
              return specimenSource?.display
                ? specimenSource?.display.replace("SPECIMEN_SOURCE:", "")
                : "-";
            };

            $scope.getAuthorizationStatus = (authorizationStatuses) => {
              return authorizationStatuses.length > 0
                ? authorizationStatuses[authorizationStatuses.length - 1]
                : null;
            };

            $scope.getResult = (results) => {
              if (results.length === 0) {
                return "-";
              }

              const result = results[results.length - 1];
              return result?.valueCoded
                ? result?.valueCoded?.display
                : result?.valueText
                ? result?.valueText
                : result?.valueNumeric
                ? result?.valueNumeric
                : "-";
            };

            $scope.getSamples = (event, action) => {
              $scope.currentPage =
                action === "next"
                  ? $scope.currentPage + 1
                  : $scope.currentPage - 1;
              $scope.reportDimensions = {
                itemsPerPage: $scope.itemsPerPage,
                page: $scope.currentPage,
                startDate: $scope.startDate.toISOString(),
                endDate: $scope.endDate.toISOString(),
              };
              $scope.loadData($scope.reportDimensions);
            };

            $scope.getSelectedDepartment = (event, selectedDepartment) => {
              $scope.selectedDepartment = selectedDepartment;
              $scope.reportDimensions = {
                itemsPerPage: $scope.itemsPerPage,
                page: $scope.currentPage,
                department: $scope.selectedDepartment,
                testOrder: $scope.testOrder,
                specimenSource: $scope.specimenSource,
                equipment: $scope.equipment,
                startDate: $scope.startDate.toISOString(),
                endDate: $scope.endDate.toISOString(),
              };
              $scope.loadData($scope.reportDimensions);
            };

            $scope.getReport = (startDate, endDate) => {
              $scope.startDate = startDate;
              $scope.endDate = endDate;
              $scope.reportDimensions = {
                ...$scope.reportDimensions,
                startDate: $scope.startDate.toISOString(),
                endDate: $scope.endDate.toISOString(),
              };
              if ($scope.startDate && $scope.endDate) {
                $scope.loadData($scope.reportDimensions);
              }
            };
          },
        ]);
    </script>
  </head>
  <body>
    <div id="report-app" ng-app="reportModule" ng-controller="reportController">
      <h3 class="text-center"><b> Audit Trail </b></h3>
      <div class="w-100" ng-if="departments">
        StartDate:
        <input
          class="date-input"
          ng-model="startDate"
          max="{{today}}"
          placeholder="Start date"
          type="date"
        />
        <span style="margin-left: 8px">
          End Date:
          <input
            class="date-input"
            ng-model="endDate"
            placeholder="End date"
            type="date"
          />
        </span>
        <select
          style="margin-left: 8px"
          class="item-selection"
          ng-options="item as item.display for item in departments track by item.uuid"
          ng-model="selectedDepartment"
          ng-change="getSelectedDepartment($event,selectedDepartment)"
        ></select>
        <button
          ng-disabled="!startDate || !endDate"
          style="margin-left: 8px"
          ng-click="getReport(startDate,endDate)"
        >
          Get Report
        </button>
      </div>
      <div style="width: 100%; overflow: auto; margin-top: 8px">
        <table class="table table-bordered" ng-if="!loading">
          <thead>
            <tr>
              <th>SN</th>
              <th>Lab</th>
              <th>Department</th>
              <th>Specimen Source</th>
              <th>Lab No</th>
              <th>Registered On</th>
              <th>Priority</th>
              <th>File No.</th>
              <th>Test Order</th>
              <th>Has Results?</th>
              <th>Authorized?</th>
              <th>Authorized On</th>
              <th colspan="{{maximumParametersCount}}">Test Parameters</th>
            </tr>
          </thead>
          <tbody ng-repeat="sampleTestOrder in samplesData.results">
            <tr>
              <td style="width: 50px">{{$index + 1}}</td>
              <td style="width: 120px">
                {{sampleTestOrder.location.display ?
                sampleTestOrder.location.display: '-'}}
              </td>
              <td>{{getDepertmentName(sampleTestOrder.concept.uuid)}}</td>
              <td>{{getSpecimenSourceName(sampleTestOrder.specimenSource)}}</td>
              <td>{{sampleTestOrder.label}}</td>
              <td>{{sampleTestOrder.dateTimeCreated | date:"medium" }}</td>
              <td>{{sampleTestOrder.priority.remarks}}</td>
              <td>{{sampleTestOrder.patient.identifiers[0].id}}</td>
              <td>
                {{formatTestOrderName(sampleTestOrder.testOrder.concept.display)}}
              </td>
              <td>{{sampleTestOrder.results.length > 0 ? "Y": "N"}}</td>
              <td>
                {{sampleTestOrder.authorizationStatuses.length > 0 ? "Y": "N"}}
              </td>
              <td>
                {{ authorizationStatuses ?
                (getAuthorizationStatus(sampleTestOrder.authorizationStatuses) ?
                (getAuthorizationStatus(sampleTestOrder.authorizationStatuses).timestamp
                | date:"medium"):"-"): "-"}}
              </td>
              <td ng-repeat="testAllocation in sampleTestOrder.testAllocations">
                <p>{{testAllocation.concept.display}}</p>
                <p style="text-align: center">
                  <b> {{ getResult(testAllocation.results)}} </b>
                </p>
              </td>
            </tr>
          </tbody>
        </table>
        <div
          style="width: 100"
          ng-if=" !loading && ((samplesData.results && samplesData.results.length === 0) || !samplesData)"
        >
          NO data
        </div>
        <div
          ng-if="loading"
          style="
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <div class="loader"></div>
        </div>
      </div>
      <div
        ng-if="!loading"
        class="d-flex justify-content-end"
        style="margin-top: 16px"
      >
        <button
          ng-disabled="!startDate || !endDate || currentPage === 1"
          class="control-btn"
          ng-click="getSamples($event, 'prev')"
          style="margin-left: 8px"
        >
          Prev
        </button>
        <button
          ng-disabled="!startDate || !endDate || samplesData.results.length < itemsPerPage"
          class="control-btn"
          ng-click="getSamples($event, 'next')"
        >
          Next
        </button>
      </div>
    </div>
  </body>
</html>
